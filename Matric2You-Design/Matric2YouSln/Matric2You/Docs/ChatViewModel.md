# ChatViewModel — Deep Dive

This document explains the purpose, flow, and extensibility of `ChatViewModel` used in the Matric2You .NET MAUI app.

## TL;DR
- Binds a text input (`UserInput`) and send command (`SendMessageCommand`) to the UI.
- Maintains:
  - UI chat stream: `ObservableCollection<ChatItem> ChatItems`
  - Model history for context: `List<ChatMessage> _history` (OpenAI-compatible)
- Uses `SparkChatService` to get AI responses with retrieval.
- Renders assistant replies with KaTeX inside a `WebView` for high-quality math.

---

## Public API

- Properties
  - `string UserInput` — Two-way bound to the message entry text.
  - `ObservableCollection<ChatItem> ChatItems` — ItemsSource for the chat list (user + bot bubbles).
- Commands
  - `IAsyncRelayCommand SendMessageCommand` — Generated by `[RelayCommand]` on `SendMessage()`.

Constructor
- `ChatViewModel(SparkChatService chatService)` — Service dependency injected by the container.

---

## Conversation Flow

1) User types text into an input bound to `UserInput`.
2) User triggers `SendMessageCommand` (button tap or Enter).
3) ViewModel:
   - Pushes a user `ChatItem` to `ChatItems`.
   - Adds a `UserChatMessage` to `_history`.
   - Calls `SparkChatService.GetChatCompletionWithDataAsync(input, _history, allowGenerativeSupplement: true)`.
   - Receives the assistant reply (string).
   - Adds an `AssistantChatMessage` to `_history`.
   - Pushes a bot `ChatItem` to `ChatItems`, with:
     - `Content` set to the reply string.
     - `HtmlSource` set to a KaTeX-rendered `HtmlWebViewSource`.

Finally, `UserInput` is cleared.

---

## Data Structures

- `ChatItem`
  - `bool IsUser` — Distinguishes user vs bot bubble.
  - `string Role` — "You" or "Bot".
  - `string Content` — Plain text reply (also a fallback if HTML fails).
  - `HtmlWebViewSource? HtmlSource` — For bot messages with math; bound to a `WebView`.

- `_history: List<ChatMessage>`
  - Backing history for the AI model, using `OpenAI.Chat` message types.
  - Ensures responses remain contextual.

---

## Service Integration

`SparkChatService.GetChatCompletionWithDataAsync` is called with:
- `userMessage`: current user input.
- `history`: the entire conversation so far.
- `allowGenerativeSupplement`: enables the model to answer beyond retrieved content if needed.

Returned `reply` is:
- Added to `_history` as `AssistantChatMessage`.
- Displayed in the UI via a new bot `ChatItem`.

---

## Math Rendering with KaTeX

Assistant replies are rendered as math when relevant:

1) `ConvertReplyToLatex`:
   - Heuristically detects if the reply already looks like LaTeX (e.g., `\frac`, `\sqrt`, `\sum`, `$`, `\[`).
   - If not, wraps content in `\text{...}` after escaping.

2) `EscapeForLatexText`:
   - Escapes characters that would otherwise break LaTeX parsing:
     - Example: `\` → `\textbackslash{}`, `$` → `\$`, `{` → `\{}`, etc.

3) `BuildKaTeXHtmlSource`:
   - Produces a parent HTML that hosts an iframe.
   - The iframe loads KaTeX from a CDN and renders the LaTeX string.
   - Uses `JsonSerializer.Serialize` to safely inject the LaTeX into JS (prevents breaking due to quotes/newlines).
   - Automatically resizes the iframe to fit content height.

Notes:
- CDN availability is required. Consider shipping KaTeX locally for offline/enterprise scenarios.

---

## Threading and UI

- `SendMessage` is `async` and is typically invoked on the UI thread.
- `ChatItems` is updated directly; ensure any off-UI calls marshal back to the main thread before updating UI-bound collections.

---

## Typical .NET MAUI Bindings (Example)

XAML: